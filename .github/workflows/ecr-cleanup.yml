name: ECR-Cleanup

# Run every day at midnight (server time UTC)
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:  # allows manual trigger from GitHub Actions

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-south-1

    - name: List dangling images
      run: |
        aws ecr list-images \
          --repository-name demo-app \
          --filter tagStatus=UNTAGGED \
          --query 'imageIds[*]' \
          --output json > images.json

    - name: Delete dangling images
      run: |
        if [ -s images.json ]; then
          aws ecr batch-delete-image \
            --repository-name demo-app \
            --image-ids file://images.json
          echo "Dangling images deleted!"
        else
          echo "No dangling images found."
        fi
